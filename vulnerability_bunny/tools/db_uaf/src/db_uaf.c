#include "dr_defines.h"
#include "drext.h"
#include "dr_api.h"
#include "drmgr.h"
#include "drwrap.h"
#include "vulnerability_bunny.h"

static void event_exit() {

    vb_exit();
    ub_sa_exit();
    ib_exit();
    drmgr_exit();
}

void handle_vuln(vb_vuln_type_t type, void *vuln_info,
        ub_opnd_access_t *vuln_opnd_access, void *user_data) {

    void *drcontext = dr_get_current_drcontext();

    DR_ASSERT(tb_is_analysis_on(vb_get_taint_bunny(), drcontext));
    DR_ASSERT(type == VB_UAF_VULN);
    DR_ASSERT(!vb_is_live(vuln_info));

    uintptr_t end = vb_get_end(vuln_info);
    uintptr_t deref_addr = ib_get_comp_opnd(drcontext, vuln_opnd_access);
    uintptr_t root = vb_get_root_addr(vuln_info);

    if (end <= deref_addr || deref_addr < root) {
        /*This is not a UAF, but a HBO. */
        /* It also helps limit the pointer disp false positive for now where
         * two pointers are subtracted together, becoming untainted, and
         * the offset is added to an old
         * pointer. (Example - strops.c overflow) */

        /* TODO fix the issue related to offset confusion */
        return;
    }

    instr_t instr;
    instr_init(drcontext, &instr);

    app_pc current_pc = ib_get_pc(drcontext);
    decode(drcontext, current_pc, &instr);
    char buff[500];
    instr_disassemble_to_buffer(drcontext, &instr, buff, 500);

    dr_mcontext_t mcontext = { sizeof(mcontext), DR_MC_ALL, };
    dr_get_mcontext(drcontext, &mcontext);

    dr_fprintf(STDERR,
            "**************************************************************\n");
    dr_fprintf(STDERR, "UAF DETECTED:\n");

    app_pc creation_pc = vb_get_creation_pc(vuln_info);
    if (creation_pc) {
        dr_fprintf(STDERR, "\t Creation PC: %p\n", creation_pc);
        ub_sa_print_symb_info(creation_pc);
    }

    app_pc creation_ret_pc = vb_get_creation_ret_pc(vuln_info);
    if (creation_ret_pc) {
        dr_fprintf(STDERR, "\n\t Ret At Creation PC: %p\n", creation_ret_pc);
        ub_sa_print_symb_info(creation_ret_pc);
    }

    app_pc dangling_pc = vb_get_dangling_pc(vuln_info);
    if (dangling_pc) {
        dr_fprintf(STDERR, "\n\t Dangle PC: %p\n", dangling_pc);
        ub_sa_print_symb_info(dangling_pc);
    }

    app_pc dangling_ret_pc = vb_get_dangle_ret_pc(vuln_info);
    if (dangling_ret_pc) {
        dr_fprintf(STDERR, "\n\t Ret At Dangle PC: %p\n", dangling_ret_pc);
        ub_sa_print_symb_info(dangling_ret_pc);
    }

    dr_fprintf(STDERR, "\n\t Use PC: %p\n", current_pc);

    dr_fprintf(STDERR, "\n\t Actual Address: %p\n", deref_addr);
    dr_fprintf(STDERR, "\n\t Root Address: %p\n", root);

    dr_fprintf(STDERR, "\n\t Instr: %s\n", buff);
    dr_fprintf(STDERR, "\n\t Debug Info (if available):\n");
    ub_sa_print_symb_info(current_pc);

    dr_fprintf(STDERR,
            "**************************************************************\n\n");

    instr_free(drcontext, &instr);

    dr_abort_with_code(1);
}

DR_EXPORT void dr_client_main(client_id_t id, int argc, const char *argv[]) {

    drmgr_init();
    ib_init(NULL);
    ub_sa_init();
    vb_init(id, handle_vuln, VB_EV_DETECT_UAF, NULL);

    dr_register_exit_event(event_exit);
}

