/*
 * vb_standard_check.c
 *
 *      Author: john
 */

#include "vb_standard_check.h"

#include "drreg.h"
#include "string.h"

#include "../instrumentation/vb_spill.h"

#include "../vb_private.h"
#include "vb_check.h"

/*********************************************************************************
 * Checks when instruction has a dereference at src 1
 */

void vb_first_smem_check_helper(void *drcontext, instrlist_t *ilist,
        instr_t *where, void *user_data, void *spill_data, size_t opnd_size) {

    vb_context_t *vb_ctx = (vb_context_t *) user_data;

    ub_opnd_access_t addr_slot;
    addr_slot.opnd_field = UB_SRC_OPND_1;
    addr_slot.comp_field = UB_COMP_1;

    ub_opnd_access_t base_slot;
    base_slot.opnd_field = UB_SRC_OPND_1;
    base_slot.comp_field = UB_COMP_2;

    vb_standard_check(vb_ctx, drcontext, ilist, where, opnd_size,
            &base_slot, &addr_slot, vb_handle_uaf_1_src, vb_handle_hbo_1_src,
            vb_reg1, vb_reg2);

}

void vb_first_smem_1_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            1);
}

void vb_first_smem_2_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            2);
}

void vb_first_smem_4_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            4);
}

void vb_first_smem_8_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            8);
}

void vb_first_smem_16_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            16);
}

/*********************************************************************************
 * Checks when instruction has a dereference at src 2
 */

void vb_second_smem_check_helper(void *drcontext, instrlist_t *ilist,
        instr_t *where, void *user_data, void *spill_data, size_t opnd_size) {

    vb_context_t *vb_ctx = (vb_context_t *) user_data;

    ub_opnd_access_t addr_slot;
    addr_slot.opnd_field = UB_SRC_OPND_2;
    addr_slot.comp_field = UB_COMP_1;

    ub_opnd_access_t base_slot;
    base_slot.opnd_field = UB_SRC_OPND_2;
    base_slot.comp_field = UB_COMP_2;

    vb_standard_check(vb_ctx, drcontext, ilist, where, opnd_size,
            &base_slot, &addr_slot, vb_handle_uaf_2_src, vb_handle_hbo_2_src,
            vb_reg1, vb_reg2);
}

void vb_second_smem_1_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_second_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            1);
}

void vb_second_smem_2_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_second_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            2);
}

void vb_second_smem_4_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_second_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            4);
}

void vb_second_smem_8_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_second_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            8);
}

void vb_second_smem_16_check(void *drcontext, instrlist_t *ilist,
        instr_t *where, instr_t *app_instr, void *user_data, void *spill_data) {

    vb_second_smem_check_helper(drcontext, ilist, where, user_data, spill_data,
            16);
}

/*********************************************************************************
 * Checks when instruction has a dereference at dst 1
 */

static void vb_first_dmem_check_helper(void *drcontext, instrlist_t *ilist,
        instr_t *where, instr_t *app_instr, void *user_data, void *spill_data,
        size_t opnd_size) {

    vb_context_t *vb_ctx = (vb_context_t *) user_data;

    ub_opnd_access_t addr_slot;
    addr_slot.opnd_field = UB_DST_OPND_1;
    addr_slot.comp_field = UB_COMP_1;

    ub_opnd_access_t base_slot;
    base_slot.opnd_field = UB_DST_OPND_1;
    base_slot.comp_field = UB_COMP_2;

    vb_standard_check(vb_ctx, drcontext, ilist, where, opnd_size,
            &base_slot, &addr_slot, vb_handle_uaf_1_dst, vb_handle_hbo_1_dst,
            vb_reg1, vb_reg2);

}

void vb_first_dmem_1_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_dmem_check_helper(drcontext, ilist, where, app_instr, user_data,
            spill_data, 1);
}

void vb_first_dmem_2_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_dmem_check_helper(drcontext, ilist, where, app_instr, user_data,
            spill_data, 2);
}

void vb_first_dmem_4_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_dmem_check_helper(drcontext, ilist, where, app_instr, user_data,
            spill_data, 4);
}

void vb_first_dmem_8_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_dmem_check_helper(drcontext, ilist, where, app_instr, user_data,
            spill_data, 8);

}

void vb_first_dmem_16_check(void *drcontext, instrlist_t *ilist, instr_t *where,
        instr_t *app_instr, void *user_data, void *spill_data) {

    vb_first_dmem_check_helper(drcontext, ilist, where, app_instr, user_data,
            spill_data, 16);
}
