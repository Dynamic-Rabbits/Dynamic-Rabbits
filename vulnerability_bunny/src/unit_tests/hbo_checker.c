/*
 * uaf_checker.c
 *
 *      Author: john
 */

#include "dr_defines.h"
#include "vulnerability_bunny.h"

bool detected = false;

static void event_exit() {

    DR_ASSERT(detected);

    vb_exit();
    ub_sa_exit();
    ib_exit();
    drmgr_exit();
}

void handle_vuln(vb_vuln_type_t type, void *vuln_info,
        ub_opnd_access_t *vuln_slot, void *user_data) {

    DR_ASSERT(type == VB_HEAP_BO_VULN);
    detected = true;

    uintptr_t root_addr = vb_get_root_addr(vuln_info);
    uintptr_t end = vb_get_end(vuln_info);
    size_t size = vb_get_object_size(vuln_info);
    uintptr_t opnd = ib_get_comp_opnd(dr_get_current_drcontext(), vuln_slot);

    dr_fprintf(STDERR, "OPND: %p\n", opnd);
    dr_fprintf(STDERR, "ROOT ADDR: %p\n", root_addr);
    dr_fprintf(STDERR, "END: %p\n", root_addr + size);
    dr_fprintf(STDERR, "END2: %p\n", end);
    dr_fprintf(STDERR, "pc: %p\n", ib_get_pc(dr_get_current_drcontext()));


    ub_sa_print_symb_info(ib_get_pc(dr_get_current_drcontext()));

    dr_exit_process(0);
}

DR_EXPORT void dr_client_main(client_id_t id, int argc, const char *argv[]) {

    drmgr_init();
    ib_init(NULL);
    ub_sa_init();

    vb_init(id, handle_vuln, VB_EV_DETECT_HBO, NULL);

    dr_register_exit_event(event_exit);
}

