/*
 * uaf_checker.c
 *
 *      Author: john
 */

#include "dr_defines.h"
#include "vulnerability_bunny.h"

bool detected = false;

static void event_exit() {

    DR_ASSERT(detected);

    vb_exit();
    ub_sa_exit();
    ib_exit();
    drmgr_exit();
}

void handle_vuln(vb_vuln_type_t type, void *vuln_info, ub_opnd_access_t *vuln_slot, void *user_data){

    DR_ASSERT(type == VB_UAF_VULN);

    dr_fprintf(STDERR, "\t\t DETECTED!\n");

    detected= true;

    dr_exit_process(0);
}

DR_EXPORT void dr_client_main(client_id_t id, int argc, const char *argv[]) {

    drmgr_init();
    ib_init(NULL);
    ub_sa_init();

    vb_init(id, handle_vuln, VB_EV_DETECT_UAF, NULL);

    dr_register_exit_event(event_exit);
}

