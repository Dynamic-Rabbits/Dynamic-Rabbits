/*
 * uaf_test_11.c
 *
 *      Author: john
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>


typedef struct _twoIntsStruct

{

    int intOne;

    int intTwo;

} twoIntsStruct;

void printLine(const char * line)

{

	if (line != NULL)

	{

		printf("%s\n", line);

	}

}

void printStructLine (const twoIntsStruct * structTwoIntsStruct)
{
    printf("%d -- %d\n", structTwoIntsStruct->intOne, structTwoIntsStruct->intTwo);

}

void CWE416_Use_After_Free__malloc_free_struct_02_bad()

{

    twoIntsStruct * data;

    /* Initialize data */

    data = NULL;

    if(1)

    {

        data = (twoIntsStruct *)malloc(100*sizeof(twoIntsStruct));

        if (data == NULL) {exit(-1);}
        {

            size_t i;

            for(i = 0; i < 100; i++)

            {

                data[i].intOne = 1;

                data[i].intTwo = 2;

            }

        }

        /* POTENTIAL FLAW: Free data in the source - the bad sink attempts to use data */

        free(data);

    }

    if(1)

    {

        printStructLine(&data[0]);

    }

}


int main(int argc, char * argv[])

{

    printLine("Calling bad()...");

    CWE416_Use_After_Free__malloc_free_struct_02_bad();

    printLine("Finished bad()");

    return 0;

}




