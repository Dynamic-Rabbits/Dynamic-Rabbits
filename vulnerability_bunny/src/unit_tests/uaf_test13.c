/*
 * uaf_test13.c
 *
 *      Author: john
 */




/* TEMPLATE GENERATED TESTCASE FILE

Filename: CWE416_Use_After_Free__malloc_free_struct_18.c

Label Definition File: CWE416_Use_After_Free__malloc_free.label.xml

Template File: sources-sinks-18.tmpl.c

*/

/*

 * @description

 * CWE: 416 Use After Free

 * BadSource:  Allocate data using malloc(), initialize memory block, and Deallocate data using free()

 * GoodSource: Allocate data using malloc() and initialize memory block

 * Sinks:

 *    GoodSink: Do nothing

 *    BadSink : Use data

 * Flow Variant: 18 Control flow: goto statements

 *

 * */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct _twoIntsStruct
{

    int intOne;
    int intTwo;

} twoIntsStruct;

void printLine(const char * line)

{

	if (line != NULL)

	{

		printf("%s\n", line);

	}

}

void printStructLine (const twoIntsStruct * structTwoIntsStruct)
{
    printf("%d -- %d\n", structTwoIntsStruct->intOne, structTwoIntsStruct->intTwo);

}

void CWE416_Use_After_Free__malloc_free_struct_18_bad()

{

    twoIntsStruct * data;

    /* Initialize data */

    data = NULL;

    goto source;

source:

    data = (twoIntsStruct *)malloc(100*sizeof(twoIntsStruct));

    if (data == NULL) {exit(-1);}
    {

        size_t i;

        for(i = 0; i < 100; i++)

        {

            data[i].intOne = 1;

            data[i].intTwo = 2;

        }

    }

    /* POTENTIAL FLAW: Free data in the source - the bad sink attempts to use data */

    free(data);

    goto sink;

sink:

    /* POTENTIAL FLAW: Use of data that may have been freed */

    printStructLine(&data[0]);

    /* POTENTIAL INCIDENTAL - Possible memory leak here if data was not freed */

}



int main(int argc, char * argv[])

{
    printLine("Calling bad()...");

    CWE416_Use_After_Free__malloc_free_struct_18_bad();

    printLine("Finished bad()");
    return 0;

}
