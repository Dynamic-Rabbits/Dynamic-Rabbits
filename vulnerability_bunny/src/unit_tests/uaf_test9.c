/*
 * uaf_test9.c
 *
 *      Author: john
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void printIntLine(int intNumber) {
	printf("%d\n", intNumber);
}

void printLine(const char * line) {

	if (line != NULL) {
		printf("%s\n", line);
	}
}

void CWE416_Use_After_Free__malloc_free_int_12_bad() {

	int * data;

	/* Initialize data */

	data = NULL;

	if (1)

	{

		data = (int *) malloc(100 * sizeof(int));

		if (data == NULL) {
			exit(-1);
		}
		{

			size_t i;

			for (i = 0; i < 100; i++)

			{

				data[i] = 5;

			}

		}

		/* POTENTIAL FLAW: Free data in the source - the bad sink attempts to use data */

		free(data);

	}

	else

	{

		data = (int *) malloc(100 * sizeof(int));

		if (data == NULL) {
			exit(-1);
		}
		{

			size_t i;

			for (i = 0; i < 100; i++)

			{

				data[i] = 5;

			}

		}

		/* FIX: Do not free data in the source */

	}

	if (1)

	{

		/* POTENTIAL FLAW: Use of data that may have been freed */

		printIntLine(data[0]);

		/* POTENTIAL INCIDENTAL - Possible memory leak here if data was not freed */

	}

	else

	{

		/* FIX: Don't use data that may have been freed already */

		/* POTENTIAL INCIDENTAL - Possible memory leak here if data was not freed */

		/* do nothing */

		; /* empty statement needed for some flow variants */

	}

}

int main(int argc, char * argv[]) {

	printLine("Calling bad()...");

	CWE416_Use_After_Free__malloc_free_int_12_bad();

	printLine("Finished bad()");

	return 0;
}
