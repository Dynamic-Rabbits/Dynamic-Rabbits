/*
 * vb_cc_taint_policy.c
 *
 *      Author: john
 */

#include "vb_cc_taint_policy.h"
#include "../vb_private.h"

static void *propogate_func_1dst_1src(void *src1_opaque);
static void *propogate_func_1dst_2src(void *src1_opaque, void *src2_opaque);
static bool meet(void **meet_tl, void *src_opaque);

DR_EXPORT void vb_tl_cc_initialise_taint_policy(tb_cc_taint_policy_t *taint_policy) {

    memset(taint_policy, 0, sizeof(tb_cc_taint_policy_t));

    taint_policy->new_ref_tl_func = vb_tl_new_ref;
    taint_policy->delete_ref_tl_func = vb_tl_delete_ref;

    taint_policy->meet_func = meet;
    taint_policy->propagate_1dst_1src_func = propogate_func_1dst_1src;
    taint_policy->propagate_1dst_2src_func = propogate_func_1dst_2src;

    taint_policy->get_default_label = NULL;
}

static void *propogate_func_1dst_1src(void *src1_opaque) {

    return src1_opaque;
}

static void *propogate_func_1dst_2src(void *src1_opaque, void *src2_opaque) {

    vb_heap_ptr_t *src1 = (vb_heap_ptr_t *) src1_opaque;
    vb_heap_ptr_t *src2 = (vb_heap_ptr_t *) src2_opaque;

    if (src1 == NULL && src2 != NULL) {
        return src2;
    } else if (src1 != NULL && src2 == NULL) {
        return src1;
    }

    return NULL;
}

static bool meet(void **meet_tl, void *src_opaque) {

    vb_heap_ptr_t **meet_ptr = (vb_heap_ptr_t **) meet_tl;

    if (src_opaque == NULL && *meet_ptr != NULL){
        return !((*meet_ptr)->is_live);

    } else if (src_opaque != NULL && *meet_ptr == NULL){
        *meet_ptr = src_opaque;
        return !((*meet_ptr)->is_live);

    }else if (src_opaque != NULL && *meet_ptr != NULL){

        /* Unlikely to occur in practice */
        vb_heap_ptr_t *src = (vb_heap_ptr_t *) src_opaque;

        if (src->is_live && !((*meet_ptr)->is_live))
            return true;
        else if (!src->is_live && (*meet_ptr)->is_live){
            *meet_ptr = src_opaque;
            return true;
        }
    }

    return false;
}
