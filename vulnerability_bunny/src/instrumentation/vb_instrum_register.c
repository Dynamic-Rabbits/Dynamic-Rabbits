/*
 * vb_instrum_register.c
 *
 *      Author: john
 */

#include "vb_instrum_register.h"

#include "drreg.h"
#include "string.h"

#include "vb_spill.h"

#include "../vb_private.h"
#include "../check/vb_standard_check.h"
#include "../check/vb_rep_check.h"

/*****************************************************************
 * Prototypes
 */

static bool vb_is_movzx_dreg_4_smem_1_instr(instr_t *instr);
static bool vb_is_movzx_dreg_4_smem_2_instr(instr_t *instr);

static bool vb_is_srcdst_src_dmem_1_simm_1_instr(instr_t *instr);
static bool vb_is_srcdst_src_dmem_2_simm_2_instr(instr_t *instr);
static bool vb_is_srcdst_src_dmem_4_simm_4_instr(instr_t *instr);

bool vb_is_srcdst_src_dmem_1_sreg_1_instr(instr_t *instr);
bool vb_is_srcdst_src_dmem_2_sreg_2_instr(instr_t *instr);
bool vb_is_srcdst_src_dmem_4_sreg_4_instr(instr_t *instr);

bool vb_is_srcdst_src_dreg_1_smem_1_instr(instr_t *instr);
bool vb_is_srcdst_src_dreg_2_smem_2_instr(instr_t *instr);
bool vb_is_srcdst_src_dreg_4_smem_4_instr(instr_t *instr);
bool vb_is_srcdst_src_dreg_8_smem_8_instr(instr_t *instr);

bool vb_is_mov_dreg_16_smem_8_instr(instr_t *instr);
bool vb_is_mov_dmem_8_sreg_16_instr(instr_t *instr);

bool vb_is_mov_dreg_1_smem_1_instr(instr_t *instr);
bool vb_is_mov_dreg_2_smem_2_instr(instr_t *instr);
bool vb_is_mov_dreg_4_smem_4_instr(instr_t *instr);
bool vb_is_mov_dreg_8_smem_8_instr(instr_t *instr);
bool vb_is_mov_dreg_16_smem_16_instr(instr_t *instr);

bool vb_is_mov_dmem_1_simm_1_instr(instr_t *instr);
bool vb_is_mov_dmem_2_simm_2_instr(instr_t *instr);
bool vb_is_mov_dmem_4_simm_4_instr(instr_t *instr);

bool vb_is_mov_dmem_1_sreg_1_instr(instr_t *instr);
bool vb_is_mov_dmem_2_sreg_2_instr(instr_t *instr);
bool vb_is_mov_dmem_4_sreg_4_instr(instr_t *instr);
bool vb_is_mov_dmem_8_sreg_8_instr(instr_t *instr);
bool vb_is_mov_dmem_16_sreg_16_instr(instr_t *instr);

/*****************************************************************
 * Implementation
 */

void vb_register_checks(vb_context_t *vb_ctx) {

    /**
     *  TODO:
     *  There are many more instr to hook but these are the most popular
     *  Keep calm, it's just a prototype! :)
     */

    IB_INSTRUM_OPT option = IB_OPT_ADDR_OPND_INFO
            | IB_OPT_ADDR_GEN_INFO | IB_OPT_PC_INFO
            | IB_OPT_REG_OPND_INFO;

    ib_insert_hndle_data_t cache_data;
    cache_data.spilling_user_data = NULL;
    cache_data.spill_reg_func = vb_spill_two_regs;
    cache_data.restore_reg_func = vb_restore_two_regs;
    cache_data.user_data = vb_ctx;

    /**
     * Handle movdqu
     */
    cache_data.user_instrum_func = vb_first_smem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqu, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_16_smem_16_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqu, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_16_sreg_16_instr, IB_GUARD_HOOK);

    /**
     * Handle OP_movdqa
     */
    cache_data.user_instrum_func = vb_first_smem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqu, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_16_smem_16_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqu, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_16_sreg_16_instr, IB_GUARD_HOOK);

    /**
     * Handle OP_movdqa
     */
    cache_data.user_instrum_func = vb_first_smem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqa, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_16_smem_16_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_16_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movdqa, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_16_sreg_16_instr, IB_GUARD_HOOK);

    /**
     * Handle mov st
     */

    cache_data.user_instrum_func = vb_first_dmem_1_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_1_sreg_1_instr, IB_GUARD_HOOK);
    cache_data.user_instrum_func = vb_first_dmem_1_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_1_simm_1_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_2_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_2_sreg_2_instr, IB_GUARD_HOOK);
    cache_data.user_instrum_func = vb_first_dmem_2_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_2_simm_2_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_4_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_4_sreg_4_instr, IB_GUARD_HOOK);
    cache_data.user_instrum_func = vb_first_dmem_4_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_st, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_4_simm_4_instr, IB_GUARD_HOOK);

    /**
     * Handle movd
     */
    cache_data.user_instrum_func = vb_first_smem_4_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movd, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_4_smem_4_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_4_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movd, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_4_sreg_4_instr, IB_GUARD_HOOK);

    /**
     * Handle movq
     */
    cache_data.user_instrum_func = vb_first_smem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movq, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_8_smem_8_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movq, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_8_sreg_8_instr, IB_GUARD_HOOK);

    /**
     * Handle mov ld
     */
    cache_data.user_instrum_func = vb_first_smem_1_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_ld, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_1_smem_1_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_2_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_ld, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_2_smem_2_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_4_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_mov_ld, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_4_smem_4_instr, IB_GUARD_HOOK);

    /**
     * Handle movlp
     */
    cache_data.user_instrum_func = vb_first_dmem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movlpd, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_8_sreg_16_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movlpd, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_16_smem_8_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_dmem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movlps, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dmem_8_sreg_16_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_8_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movlps, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_mov_dreg_16_smem_8_instr, IB_GUARD_HOOK);

    /**
     * Handle src srcdst
     */
    int srcdst_src_instrs[5] = { OP_xor, OP_add, OP_sub, OP_and, OP_or };
    for (int i = 0; i < 5; i++) {

        /* Case where src is mem opnd */
        cache_data.user_instrum_func = vb_first_smem_1_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dreg_1_smem_1_instr, IB_GUARD_HOOK);

        cache_data.user_instrum_func = vb_first_smem_2_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dreg_2_smem_2_instr, IB_GUARD_HOOK);

        cache_data.user_instrum_func = vb_first_smem_4_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dreg_4_smem_4_instr, IB_GUARD_HOOK);

        /* Case where dst is mem opnd */

        cache_data.user_instrum_func = vb_first_dmem_1_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_1_sreg_1_instr, IB_GUARD_HOOK);
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_1_simm_1_instr, IB_GUARD_HOOK);

        cache_data.user_instrum_func = vb_first_dmem_2_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_2_sreg_2_instr, IB_GUARD_HOOK);
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_2_simm_2_instr, IB_GUARD_HOOK);

        cache_data.user_instrum_func = vb_first_dmem_4_check;
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_4_sreg_4_instr, IB_GUARD_HOOK);
        ib_hook_cache_to_instr_ex(vb_ctx->tool_id, srcdst_src_instrs[i],
                &cache_data, option, IB_INSTRUM_BEFORE,
                vb_is_srcdst_src_dmem_4_simm_4_instr, IB_GUARD_HOOK);
    }

    /**
     * Handle movzx
     */
    cache_data.user_instrum_func = vb_first_smem_1_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movzx, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_movzx_dreg_4_smem_1_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_2_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movzx, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_movzx_dreg_4_smem_2_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_1_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movsx, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_movzx_dreg_4_smem_1_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_first_smem_2_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_movsx, &cache_data, option,
    IB_INSTRUM_BEFORE, vb_is_movzx_dreg_4_smem_2_instr, IB_GUARD_HOOK);

    /*
     * Handle rep instructions
     */

    option = IB_OPT_ADDR_GEN_INFO | IB_OPT_ADDR_OPND_INFO
            | IB_OPT_PC_INFO | IB_OPT_REG_OPND_INFO | IB_OPT_CONC_INFO
            | IB_OPT_FLAG_INFO;

    cache_data.spill_reg_func = vb_spill_three_regs;
    cache_data.restore_reg_func = vb_restore_three_regs;

    cache_data.user_instrum_func = vb_rep_movsb_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_movs, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_movsb_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_movsw_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_movs, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_movsw_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_movsd_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_movs, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_movsd_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_movsq_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_movs, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_movsq_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_stosb_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_stos, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_stosb_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_stosw_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_stos, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_stosw_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_stosd_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_stos, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_stosd_instr, IB_GUARD_HOOK);

    cache_data.user_instrum_func = vb_rep_stosq_check;
    ib_hook_cache_to_instr_ex(vb_ctx->tool_id, OP_rep_stos, &cache_data, option,
    IB_INSTRUM_BEFORE, ub_is_rep_stosq_instr, IB_GUARD_HOOK);
}

/**
 * Guards
 */

static bool uaf_does_base_exist(opnd_t opnd) {

    if (opnd_is_base_disp(opnd)) {

        reg_id_t reg = opnd_get_base(opnd);

        return reg != DR_REG_NULL && reg_is_gpr(reg);
    }

    return false;
}

static bool vb_is_movzx_dreg_4_smem_1_instr(instr_t *instr) {

    return ub_is_movzx_dreg_4_smem_1_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

static bool vb_is_movzx_dreg_4_smem_2_instr(instr_t *instr) {

    return ub_is_movzx_dreg_4_smem_2_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

static bool vb_is_srcdst_src_dmem_1_simm_1_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_1_simm_1_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

static bool vb_is_srcdst_src_dmem_2_simm_2_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_2_simm_2_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

static bool vb_is_srcdst_src_dmem_4_simm_4_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_4_simm_4_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_srcdst_src_dmem_1_sreg_1_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_1_sreg_1_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_srcdst_src_dmem_2_sreg_2_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_2_sreg_2_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_srcdst_src_dmem_4_sreg_4_instr(instr_t *instr) {

    return ub_is_srcdst_src_dmem_4_sreg_4_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_srcdst_src_dreg_1_smem_1_instr(instr_t *instr) {
    return ub_is_srcdst_src_dreg_1_smem_1_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_srcdst_src_dreg_2_smem_2_instr(instr_t *instr) {
    return ub_is_srcdst_src_dreg_2_smem_2_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_srcdst_src_dreg_4_smem_4_instr(instr_t *instr) {
    return ub_is_srcdst_src_dreg_4_smem_4_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_srcdst_src_dreg_8_smem_8_instr(instr_t *instr) {
    return ub_is_srcdst_src_dreg_8_smem_8_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dreg_16_smem_8_instr(instr_t *instr) {

    return ub_is_mov_dreg_16_smem_8_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dmem_8_sreg_16_instr(instr_t *instr) {

    return ub_is_mov_dmem_8_sreg_16_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dreg_1_smem_1_instr(instr_t *instr) {

    return ub_is_mov_dreg_1_smem_1_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dreg_2_smem_2_instr(instr_t *instr) {

    return ub_is_mov_dreg_2_smem_2_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dreg_4_smem_4_instr(instr_t *instr) {

    return ub_is_mov_dreg_4_smem_4_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dreg_8_smem_8_instr(instr_t *instr) {

    return ub_is_mov_dreg_8_smem_8_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dreg_16_smem_16_instr(instr_t *instr) {

    return ub_is_mov_dreg_16_smem_16_instr(instr)
            && uaf_does_base_exist(instr_get_src(instr, 0));
}

bool vb_is_mov_dmem_1_simm_1_instr(instr_t *instr) {

    return ub_is_mov_dmem_1_simm_1_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_2_simm_2_instr(instr_t *instr) {

    return ub_is_mov_dmem_2_simm_2_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_4_simm_4_instr(instr_t *instr) {

    return ub_is_mov_dmem_4_simm_4_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_1_sreg_1_instr(instr_t *instr) {

    return ub_is_mov_dmem_1_sreg_1_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_2_sreg_2_instr(instr_t *instr) {

    return ub_is_mov_dmem_2_sreg_2_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_4_sreg_4_instr(instr_t *instr) {

    return ub_is_mov_dmem_4_sreg_4_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_8_sreg_8_instr(instr_t *instr) {

    return ub_is_mov_dmem_8_sreg_8_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}

bool vb_is_mov_dmem_16_sreg_16_instr(instr_t *instr) {

    return ub_is_mov_dmem_16_sreg_16_instr(instr)
            && uaf_does_base_exist(instr_get_dst(instr, 0));
}
